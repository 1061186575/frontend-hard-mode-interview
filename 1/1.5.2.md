# 壹.5.2 了解TCP、UDP、TLS

了解一点底层网络通信原理，对日常工作有很大的帮助，减少与后端工程师的“日常沟通摩擦”，增强共鸣和互信与理解。而在面试过程中，很多公司会考察前端工程师的知识广度，TCP/IP、TCP、UDP、TLS是被高频问到的。

 TCP/IP协议是一个协议集，里面包括很多协议的，TCP、UDP、TLS等只是其中的协议。

TCP/IP协议集包括**应用层**，**传输层**，**网络层**，**网络访问层**。

 应用层包括：

* 超文本传输协议\(HTTP\)：万维网的基本协议；
* 文件传输\(TFTP简单文件传输协议\)；
* 远程登录\(Telnet\)，提供远程访问其它主机功能，它允许用户登录；
* internet主机，并在这台主机上执行命令；
* 网络管理\(SNMP简单网络管理协议\)，该协议提供了监控网络设备的方法，以及配置管理,统计信息收集，性能管理及安全管理等；
* 域名系统\(DNS\)，该系统用于在internet中将域名及其公共广播的网络节点转换成IP地址。

传输层包括：

* TLS，也即SSL\(Secure Sockets Layer，安全套接字层\)协议，后来IETF在标准化SSL协议时，将其改名为Transport Layer Security（TLS，传输层安全）。

 网络层包括：

* Internet协议\(IP\)
* Internet控制信息协议\(ICMP\) 
* 地址解析协议\(ARP\) 
* 反向地址解析协议\(RARP\)  ****

网络访问层：

* 网络访问层又称作主机到网络层\(host-to-network\)。网络访问层的功能包括IP地址与物理地址硬件的映射，以及将IP封装成帧。基于不同硬件类型的网络接口，网络访问层定义了和物理介质的连接。

## 壹.5.2.1 TCP的三次握手

![](../.gitbook/assets/image%20%282%29.png)

如上图，三次握手分别是：

### SYN

客户端选择一个随机序列号x，并发送一个SYN数据包，其中可能还包括其他TCP标志和选项。 

### SYN ACK

服务器给x加1，并选择自己的一个随机序列号y，追加自己的标志和选项，然后返回响应。 

### ACK

客户端给x和y加1并发送握手期间的最后一个ACK数据包。 

## 壹.5.2.2 握手对延迟的影响

三次握手完成后，客户端与服务器之间就可以通信了。客户端可以在发送ACK分组之后立即发送数据，而服务器必须等接收到ACK分组之后才能发送数据。这个启动通信的过程适用于所有TCP连接，因此对所有使用TCP的应用具有非常大的性能影响，因为每次传输应用数据之前，都必须经历一次完整的往返。

举个例子，如果客户端在纽约，服务器在伦敦，要通过光纤启动一次新的TCP连接，光握手至少就要花56 ms：向伦敦发送分组需要28 ms，响应发回纽约又要28 ms。在此，连接的带宽对时间没有影响，延迟完全取决于客户端和服务器之间的往返时间，这其中主要是纽约到伦敦之间的传输时间。 三次握手带来的延迟使得每创建一个新TCP连接都要付出很大代价。而这也决定了提高TCP应用性能的关键，在于想办法重用连接。

重用TCP连接有一个方案叫“TCP Fast Open”（TFO），Linux 3.7及之后的内核已经在客户端和服务器中支持TFO，具体内容可以查阅[IETF规范](https://tools.ietf.org/html/rfc7413)。

## 壹.5.2.3 UDP

1980年8月，**UDP（User Datagram Protocol，用户数据报协议）**被John Postel加入了核心网络协议套件。UDP的主要功能和亮点并不在于它引入了什么特性，而在于它忽略的那些特性。UDP经常被称为无（Null）协议，RFC 768描述了其运作机制，全文完全可以写在一张餐巾纸上。

### 数据报

数据报（Datagram）为一个完整、独立的数据实体，携带着从源节点到目的地节点的足够信息，对这些节点间之前的数据交换和传输网络没有任何依赖。 数据报（datagram）和数据包（packet）是两个经常被人混用的词，实际上它们还是有区别的。数据包可以用来指代任何格式化的数据块，而数据报则通常只用来描述那些通过不可靠的服务传输的数据包，既不保证送达，也不发送失败通知。正因为如此，很多场合下人们都把UDP中User（用户）的U，改成Unreliable（不可靠）的U，于是UDP就成了“不可靠数据报协议”（Unreliable Datagram Protocol）。这也是为什么把UDP数据包称为数据报更为恰当的原因。

### UDP的“无协议”是怎么回事呢？

要理解为什么UDP被人称作“无协议”，必须从作为TCP和UDP下一层的IP协议说起。

IP层的主要任务就是按照地址从源主机向目标主机发送数据报（Datagram）。为此，消息会被封装在一个IP分组内（如下图），其中载明了源地址和目标地址，以及其他一些路由参数。

> 注意，数据报这个词暗示了一个重要的信息：IP层不保证消息可靠的交付，也不发送失败通知，实际上是把底层网络的不可靠性直接暴露给了上一层。

如果某个路由节点因为网络拥塞、负载过高或其他原因而删除了IP分组，那么在必要的情况下，IP的上一层协议要负责检测、恢复和重发数据。

![IPv4&#x9996;&#x90E8;](../.gitbook/assets/image%20%2834%29.png)

而UDP协议会用自己的分组结构（如下图）封装用户消息，它只增加了4个字段：源端口、目标端口、分组长度和校验和。这样，当IP把分组送达目标主机时，该主机能够拆开UDP分组，根据目标端口找到目标应用程序，然后再把消息发送过去。

![UDP&#x9996;&#x90E8;](../.gitbook/assets/image%20%284%29.png)

事实上，UDP数据报中的源端口和校验和字段都是可选的。IP分组的首部也有校验和，应用程序可以忽略UDP校验和。也就是说，所有错误检测和错误纠正工作都可以委托给上层的应用程序。说到底，UDP仅仅是在IP层之上通过嵌入应用程序的源端口和目标端口，提供了一个“应用程序多路复用”机制。明白了这一点，就可以总结一下UDP的无服务是怎么回事了：

* 不保证消息交付 _不确认，不重传，无超时。_ 
* 不保证交付顺序 _不设置包序号，不重排，不会发生队首阻塞。_
* 不跟踪连接状态 _不必建立连接或重启状态机。_
* 不需要拥塞控制 _不内置客户端或网络反馈机制。_

### 应用场合

TCP是一个面向字节流的协议，能够以多个分组形式发送应用程序消息，且对分组中的消息范围没有任何明确限制。因此，TCP连接的两端存在一个连接状态，每个分组都有序号，丢失还要重发，并且要按顺序交付。相对来说，UDP数据报有明确的限制：数据报必须封装在IP分组中，应用程序必须读取完整的消息。换句话说，数据报不能分片。 

UDP是一个简单、无状态的协议，适合作为其他上层应用协议的辅助。实际上，这个协议的所有决定都需要由上层的应用程序作出。

有些应用程序可能并不需要可靠的交付或者不需要按顺序交付。比如，每个分组都是独立的消息，那么按顺序交付就没有任何必要。而且，如果每个消息都会覆盖之前的消息，那么可靠交付同样也没有必要了。可惜的是，TCP不支持这种情况，所有分组必须按顺序交付。 

无需按序交付数据或能够处理分组丢失的应用程序，以及对延迟或抖动要求很高的应用程序，最好选择UDP等协议。

## 壹.5.2.4 TLS

### TLS的四次握手

客户端与服务器在通过TLS交换数据之前，必须协商建立加密信道。协商内容包括TLS版本、加密套件，必要时还会验证证书。然而，协商过程的每一步都需要一个分组在客户端和服务器之间往返一次（如下图，绿色部分代表TLS的四次握手），因而所有TLS连接启动时都要经历一定的延迟。

![](../.gitbook/assets/image%20%2818%29.png)

### 详细解说如下

#### 1.客户端发出请求（ClientHello）

首先，客户端（通常是浏览器）先向服务器发出加密通信的请求，这被叫做ClientHello请求。在这一步，客户端主要向服务器提供以下信息：

*  支持的协议版本，比如TLS 1.0版。 
* 一个客户端生成的随机数，稍后用于生成“对话密钥”。 
* 支持的加密方法，比如RSA公钥加密。
* 支持的压缩方法。

#### 2.服务器回应（SeverHello）

* 确认使用的加密通信协议版本，比如TLS 1.0版本。如果浏览器与服务器支持的版本不一致，服务器关闭加密通信。
* 确认使用的加密方法，比如RSA公钥加密，返回加密公钥。
* 服务器证书。

#### 3.客户端回应

* 验证证书的合法性（颁发证书的机构是否合法，证书中包含的网站地址是否与正在访问的地址一致等），如果证书受信任，则浏览器栏里面会显示一个小锁头，否则会给出证书不受信的提示。 
* 如果证书受信任，或者是用户接受了不受信的证书，浏览器会生成一串随机数的密码，并用证书中提供的公钥加密。 
* 使用约定好的HASH计算握手消息，并使用生成的随机数对消息进行加密，最后将之前生成的所有信息发送给网站。

#### 4.服务器

* 使用自己的私钥将信息解密取出密码，使用密码解密浏览器发来的握手消息，并验证HASH是否与浏览器发来的一致。
* 使用密码加密一段握手消息内容为"Finished"，发送给浏览器。

